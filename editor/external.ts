///<reference path='refs.ts'/>

module TDev {
  export interface ExternalEditor {
    // 3 fields are for our UI
    company: string;
    name: string;
    description: string;
    // Unique
    id: string;
    // The domain root for the external editor.
    origin: string;
    // The path from the domain root to the editor main document.
    path: string;
    // url to the logo image
    logoUrl: string;
    // order in menu
    order: number;
  }

  var externalEditorsCache: ExternalEditor[] = null;

  export function getExternalEditors(): ExternalEditor[] {
    if (!externalEditorsCache) {
      // Detect at run-time where we're running from!
      var url = Ticker.mainJsName.replace(/main.js$/, "");
      var match = url.match(/(https?:\/\/[^\/]+)(.*)/);
      var origin = match[1];
      var path = match[2];

      var isLocal = /^https?:\/\/localhost/i.test(document.location.href);
      var isTest = /^https:\/\/test\./i.test(document.location.href);
      var isStage = /^https:\/\/stage\./i.test(document.location.href);

      var CK_ORIGINS = {
        LOCAL: 'http://localhost:8888',
        TEST: 'https://microbit-development.codekingdoms.com',
        STAGE: 'https://microbit-staging.codekingdoms.com',
        LIVE: 'https://microbit.codekingdoms.com'
      };

      var PY_ORIGINS = {
        LOCAL: 'http://localhost:8000',
        TEST: 'https://microbit-test.pythonanywhere.com',
        STAGE: 'https://microbit-staging.pythonanywhere.com',
        LIVE: 'https://microbit.pythonanywhere.com'
      };


      var ckOrigin;
      var pyOrigin;

      if (isLocal && !dbg) {
        ckOrigin = CK_ORIGINS.LOCAL;
        pyOrigin = PY_ORIGINS.LOCAL;
      } else if (isTest || dbg) {
        ckOrigin = CK_ORIGINS.TEST;
        pyOrigin = PY_ORIGINS.TEST;
      } else if (isStage) {
        ckOrigin = CK_ORIGINS.STAGE;
        pyOrigin = PY_ORIGINS.STAGE;
      } else {
        ckOrigin = CK_ORIGINS.LIVE;
        pyOrigin = PY_ORIGINS.LIVE;
      }

      var ckPath = isLocal ? '/microbit/sequencer/bin/' : '/';
      var blocksPath = dbg ? "?dbg=1" : isLocal ? "?local=1" : isTest ? "?test=1" : "";

      externalEditorsCache = [ /* {
        name: "C++ Editor",
        description: "Directly write C++ code using Ace (OUTDATED)",
        id: "ace",
        origin: origin,
        path: path + "ace/editor.html"
        icon: ""
      }, */
        {
          company: "Microsoft",
          name: "Block Editor",
          description: "Drag and drop blocks to code!",
          id: "blockly",
          origin: origin,
          path: path + "blockly/editor.html" + blocksPath,
          logoUrl: "https://az742082.vo.msecnd.net/pub/vrvndwmo",
          order: 1,
        }, {
          company: "Code Kingdoms",
          name: "JavaScript",
          description: "Code JavaScript with the CK editor",
          id: 'codekingdoms',
          origin: ckOrigin,
          path: ckPath,
          logoUrl: ckOrigin + ckPath + 'img/codekingdoms-microbit.png',
          order: 0,
        }, {
          company: "The Python Software Foundation",
          name: "MicroPython",
          description: "Hack your micro:bit with MicroPython!",
          id: "python",
          origin: pyOrigin,
          path: "/editor.html",
          logoUrl: pyOrigin + '/static/img/python-powered.png',
          order: 3
      }]
    }
    return externalEditorsCache;
  }

  // Assumes that [id] is a valid external editor id.
  export function editorById(id: string): ExternalEditor {
    var r = getExternalEditors().filter(x => x.id == id);
    return r[0];
  }

  export module External {
    export var TheChannel: Channel = null;
    // We need that to setup the simulator.
    export var microbitScriptId = "lwhfye";

    import J = AST.Json;

    export function pullLatestLibraryVersion(pubId: string): Promise { // of string
      var forced = ScriptCache.forcedUpdate(pubId)
      if (forced) return Promise.as(forced.json.id)

      return Browser.TheApiCacheMgr.getAsync(pubId, Cloud.isOffline())
        .then((script: JsonScript) => {
          if (script) {
            return script.updateid;
          } else {
            // in case the one above fails, we also try the stale one from the
            // cache
            return Browser.TheApiCacheMgr.getAsync(pubId, true)
              .then(() => Promise.delay(2000))
              .then((script: JsonScript) => {
                if (script)
                  return script.updateid;
                else
                  return pubId;
              });
          }
        });
    }

    // This function modifies its argument by adding an extra [J.JLibrary]
    // to its [decls] field that references the device's library.
    function addLibrary(libMap: { [name: string]: LibEntry }, name: string, app: J.JApp): J.JLibrary {
      var resolves = libMap[name].depends.map((d: string) => {
        var quoted = AST.Lexer.quoteId(d);
        return "  usage { } resolve "+quoted+" = â™» "+quoted+" with { }\n";
      });
      var txt =
        'meta import ' + AST.Lexer.quoteId(name) + ' {\n' +
        '  pub "' + libMap[name].pubId + '"\n'+
        resolves +
        '}';
      // Apparently, parsing a "meta import" declaration with "resolves" clauses
      // generates several LibraryRef's. The first one is the one we want.
      var lib = <AST.LibraryRef> AST.Parser.parseDecls(txt)[0];
      var jLib = <J.JLibrary> J.addIdsAndDumpNode(lib);
      jLib.id = name;
      app.decls.push(jLib);
      return jLib;
    }

    function addResolves(idMap: { [name: string]: string }, lib: J.JLibrary) {
      lib.resolveClauses.forEach((c: J.JResolveClause) => {
        c.defaultLibId = <any> idMap[c.name];
      });
    }

    function addLibraries(app: J.JApp, libMap: { [i: string]: LibEntry }): Promise {
      var libNames = Object.keys(libMap);
      var latestVersions = libNames.map((name: string) => {
        return pullLatestLibraryVersion(libMap[name].pubId);
      });
      return Promise.join(latestVersions).then((latestVersions: string[]) => {
        // Update in-place the [libMap] argument with the latest [pubId]'s.
        latestVersions.map((pubId: string, i: number) => {
          libMap[libNames[i]].pubId = pubId;
        });
        // This allows us to add proper [JLibrary] declarations to the main
        // [JApp].
        var libs = libNames.map((libName: string) => addLibrary(libMap, libName, app));
        // A map from a library name to its JSON-id.
        var idMap: { [name: string]: string } = {};
        libs.forEach((l: J.JLibrary) => {
          idMap[l.name] = l.id;
        });
        // Which we need to perform a little bit of fix-up.
        libs.forEach((l: J.JLibrary) => {
          addResolves(idMap, l);
        });
      });
    }

    // For compatibility with the old format
    function fixupLibs(libs: { [i: string]: any }) {
      Object.keys(libs).forEach((k: string) => {
        if (typeof libs[k] == "string")
          libs[k] = { pubId: libs[k], depends: [] };
      });
    }

    function roundtrip1(a: J.JApp, libs: { [i: string]: LibEntry }): Promise { // of AST.App
      return addLibraries(a, libs).then(() => {
        var text = J.serialize(a);
        return Embedded.parseScript(text).then((a: AST.App) => {
          if (AST.TypeChecker.tcApp(a) > 0) {
            throw new Error("We received a script with errors and cannot compile it. " +
                "Try converting then fixing the errors manually.");
          }
          return Promise.as(a); }
        );
      });
    }

    // Takes a [JApp] and runs its through various hoops to make sure
    // everything is type-checked and resolved properly.
    function roundtrip(a: J.JApp, libs: { [i: string]: LibEntry }): Promise { // of J.JApp
      return roundtrip1(a, libs).then((a: AST.App) => {
        return Promise.as(J.dump(a));
      });
    }

    class ExternalHost extends EditorHost {
      public updateButtonsVisibility() {
      }

      public showWall() {
        super.showWall();
        document.getElementById("wallOverlay").style.display = "none";
        var w = <HTMLElement> document.querySelector(".wallFullScreenContainer");
        w.style.height = "auto";
        w.style.display = "";
        if(TheChannel.editor.id == 'python') {
            // A nice Pythonic sidebar (Python doesn't use the simulator).
            elt("externalEditorSide").style.background = "#336699 url(https://az742082.vo.msecnd.net/pub/psopafpj) 0 0 repeat";
            var bbcLogo_src = "data:image/png;base64,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/GMzLdsAADzDaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/Pgo8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzEzMiA3OS4xNTkyODQsIDIwMTYvMDQvMTktMTM6MTM6NDAgICAgICAgICI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIKICAgICAgICAgICAgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iCiAgICAgICAgICAgIHhtbG5zOnN0RXZ0PSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VFdmVudCMiCiAgICAgICAgICAgIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIKICAgICAgICAgICAgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyIKICAgICAgICAgICAgeG1sbnM6ZXhpZj0iaHR0cDovL25zLmFkb2JlLmNvbS9leGlmLzEuMC8iPgogICAgICAgICA8eG1wOkNyZWF0b3JUb29sPkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1LjUgKE1hY2ludG9zaCk8L3htcDpDcmVhdG9yVG9vbD4KICAgICAgICAgPHhtcDpDcmVhdGVEYXRlPjIwMTUtMDUtMDVUMTc6MTQ6MDQrMDE6MDA8L3htcDpDcmVhdGVEYXRlPgogICAgICAgICA8eG1wOk1ldGFkYXRhRGF0ZT4yMDE2LTEyLTE5VDEwOjUwOjI0WjwveG1wOk1ldGFkYXRhRGF0ZT4KICAgICAgICAgPHhtcDpNb2RpZnlEYXRlPjIwMTYtMTItMTlUMTA6NTA6MjRaPC94bXA6TW9kaWZ5RGF0ZT4KICAgICAgICAgPHhtcE1NOkluc3RhbmNlSUQ+eG1wLmlpZDo1ODJmMTA0OS0yY2U3LTRhNjMtYjVjNy04ZjRiM2JkY2UzN2Q8L3htcE1NOkluc3RhbmNlSUQ+CiAgICAgICAgIDx4bXBNTTpEb2N1bWVudElEPmFkb2JlOmRvY2lkOnBob3Rvc2hvcDoyZjZhZmNmYS0zMDcyLTExNzgtYTlhZS1iYWVmODNhYWNkMDU8L3htcE1NOkRvY3VtZW50SUQ+CiAgICAgICAgIDx4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ+eG1wLmRpZDo2NjAyZDdlNy04ZDEzLTRkZDgtYjFlYi05NzllOTA0ZjkxOGY8L3htcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD4KICAgICAgICAgPHhtcE1NOkhpc3Rvcnk+CiAgICAgICAgICAgIDxyZGY6U2VxPgogICAgICAgICAgICAgICA8cmRmOmxpIHJkZjpwYXJzZVR5cGU9IlJlc291cmNlIj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OmFjdGlvbj5jcmVhdGVkPC9zdEV2dDphY3Rpb24+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDppbnN0YW5jZUlEPnhtcC5paWQ6NjYwMmQ3ZTctOGQxMy00ZGQ4LWIxZWItOTc5ZTkwNGY5MThmPC9zdEV2dDppbnN0YW5jZUlEPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6d2hlbj4yMDE1LTA1LTA1VDE3OjE0OjA0KzAxOjAwPC9zdEV2dDp3aGVuPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6c29mdHdhcmVBZ2VudD5BZG9iZSBQaG90b3Nob3AgQ0MgMjAxNCAoTWFjaW50b3NoKTwvc3RFdnQ6c29mdHdhcmVBZ2VudD4KICAgICAgICAgICAgICAgPC9yZGY6bGk+CiAgICAgICAgICAgICAgIDxyZGY6bGkgcmRmOnBhcnNlVHlwZT0iUmVzb3VyY2UiPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6YWN0aW9uPnNhdmVkPC9zdEV2dDphY3Rpb24+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDppbnN0YW5jZUlEPnhtcC5paWQ6ZTNmMzZlMWItNjg3MS00Zjk4LThjZjgtOWM0ZGNhZjljMjU3PC9zdEV2dDppbnN0YW5jZUlEPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6d2hlbj4yMDE1LTA1LTA1VDE3OjE0OjA0KzAxOjAwPC9zdEV2dDp3aGVuPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6c29mdHdhcmVBZ2VudD5BZG9iZSBQaG90b3Nob3AgQ0MgMjAxNCAoTWFjaW50b3NoKTwvc3RFdnQ6c29mdHdhcmVBZ2VudD4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OmNoYW5nZWQ+Lzwvc3RFdnQ6Y2hhbmdlZD4KICAgICAgICAgICAgICAgPC9yZGY6bGk+CiAgICAgICAgICAgICAgIDxyZGY6bGkgcmRmOnBhcnNlVHlwZT0iUmVzb3VyY2UiPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6YWN0aW9uPnNhdmVkPC9zdEV2dDphY3Rpb24+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDppbnN0YW5jZUlEPnhtcC5paWQ6NTgyZjEwNDktMmNlNy00YTYzLWI1YzctOGY0YjNiZGNlMzdkPC9zdEV2dDppbnN0YW5jZUlEPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6d2hlbj4yMDE2LTEyLTE5VDEwOjUwOjI0Wjwvc3RFdnQ6d2hlbj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OnNvZnR3YXJlQWdlbnQ+QWRvYmUgUGhvdG9zaG9wIENDIDIwMTUuNSAoTWFjaW50b3NoKTwvc3RFdnQ6c29mdHdhcmVBZ2VudD4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OmNoYW5nZWQ+Lzwvc3RFdnQ6Y2hhbmdlZD4KICAgICAgICAgICAgICAgPC9yZGY6bGk+CiAgICAgICAgICAgIDwvcmRmOlNlcT4KICAgICAgICAgPC94bXBNTTpIaXN0b3J5PgogICAgICAgICA8ZGM6Zm9ybWF0PmltYWdlL3BuZzwvZGM6Zm9ybWF0PgogICAgICAgICA8cGhvdG9zaG9wOkNvbG9yTW9kZT4zPC9waG90b3Nob3A6Q29sb3JNb2RlPgogICAgICAgICA8cGhvdG9zaG9wOklDQ1Byb2ZpbGU+c1JHQiBJRUM2MTk2Ni0yLjE8L3Bob3Rvc2hvcDpJQ0NQcm9maWxlPgogICAgICAgICA8cGhvdG9zaG9wOkRvY3VtZW50QW5jZXN0b3JzPgogICAgICAgICAgICA8cmRmOkJhZz4KICAgICAgICAgICAgICAgPHJkZjpsaT5hZG9iZTpkb2NpZDpwaG90b3Nob3A6MjJmY2YwODUtMzA3Mi0xMTc4LWE5YWUtYmFlZjgzYWFjZDA1PC9yZGY6bGk+CiAgICAgICAgICAgIDwvcmRmOkJhZz4KICAgICAgICAgPC9waG90b3Nob3A6RG9jdW1lbnRBbmNlc3RvcnM+CiAgICAgICAgIDx0aWZmOk9yaWVudGF0aW9uPjE8L3RpZmY6T3JpZW50YXRpb24+CiAgICAgICAgIDx0aWZmOlhSZXNvbHV0aW9uPjMwMDAwMDAvMTAwMDA8L3RpZmY6WFJlc29sdXRpb24+CiAgICAgICAgIDx0aWZmOllSZXNvbHV0aW9uPjMwMDAwMDAvMTAwMDA8L3RpZmY6WVJlc29sdXRpb24+CiAgICAgICAgIDx0aWZmOlJlc29sdXRpb25Vbml0PjI8L3RpZmY6UmVzb2x1dGlvblVuaXQ+CiAgICAgICAgIDxleGlmOkNvbG9yU3BhY2U+MTwvZXhpZjpDb2xvclNwYWNlPgogICAgICAgICA8ZXhpZjpQaXhlbFhEaW1lbnNpb24+MTE2OTwvZXhpZjpQaXhlbFhEaW1lbnNpb24+CiAgICAgICAgIDxleGlmOlBpeGVsWURpbWVuc2lvbj4yMzI8L2V4aWY6UGl4ZWxZRGltZW5zaW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKPD94cGFja2V0IGVuZD0idyI/PqHYtxMAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAARilJREFUeNrs3XfYHVXVsPE7TwoQQhIIvYbeQXrvgoCoKIKIggoqIkixgKBgF3wpL6KvBQsWBAWkiCCI0osUkS4lQCD0GgKhpD3fH2vyGZDkaWfP7Jm5f9d1LhSSKXv2mTN7zdprD+ru7kaSJEmSJEmaky6bQJIkSZIkST0xiCRJkiRJkqQeGUSSJEmSJElSjwwiSZIkSZIkqUcGkSRJkiRJktQjg0iSJEmSJEnqkUEkSZIkSZIk9cggkiRJkiRJknpkEEmSJEmSJEk9MogkSZIkSZKkHhlEkiRJkiRJUo8MIkmSJEmSJKlHBpEkSZIkSZLUI4NIkiRJkqSBmAh0J/gcatNKeTGIJEmSJEmSpB4ZRJIkSZIkSVKPDCJJkiRJkiSpRwaRJEmSJEmS1CODSJIkSZIkSerREJtAkiT10+rAzsCmwErAGGBuYBLwGHA3cCXwZ+Alm0uSpFYZC+wCbA6sAiwMDAdeAZ4G7gKuAS4s/r9qYFB3d7etIEmSev3sAOwGfBlYr5d/5w3gTOBY4H6bUJIaZyIwKsF2DwNOtnlrZ2vgaGDbXv75GcAFwHHATTZf3pzOJkmSems54ArgbHofQAKYC/g48cbxO8BQm1KSpMZZEPhj8aywbR/+XhfwfuBG4BfAfDZlvgwiSZKk3ngn8C9gqwFsYyhwFHAVsJBNKklSY6wJ3Ap8YIDb2Rf4J7CCTZong0iSJKknOwAXAyM7tL1NiBoIBpIkSaq/NYCrgaU6tL0VgRuAlW3a/BhEkiRJc7IS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";
            var bbcLogo = div("wallFullScreenLogo", HTML.mkImg(bbcLogo_src));
            var link = HTML.mkA(null, 'http://python.org/community/microbit/', "_blank", null);
            var logo_src = TheChannel.editor.origin + '/static/img/micropython.png';
            var logo_image = HTML.mkImg(logo_src);
            link.appendChildren([logo_image]);
            var logo = div("wallFullScreenLogo", link);
            //var logo = div("wallFullScreenLogo", HTML.mkImg(TheChannel.editor.logoUrl));
            var wrapper = div("wallFullScreenWrapper");
            var snake_src = TheChannel.editor.origin + '/static/img/snake.png';
            var snake_img = HTML.mkImg(snake_src);
            snake_img.style.position = "absolute";
            snake_img.style.marginTop = "-48px";
            snake_img.style.marginLeft = "-14px";
            var header = document.createElement("span");
            header.setChildren("Instructions");
            header.style.fontSize = "3rem";
            header.style.color = "#1A354C";
            header.style.fontFamily = '"Segoe UI Light","Segoe UI","Segoe WP Light","Segoe WP","HelveticaNeue-Light","Helvetica Neue Light","Helvetica Neue",sans-serif';
            var list_items = [];
            var instructions = [
                "Type in your Python program",
                "Click 'Download' and save the file",
                "Plug in your BBC micro:bit, it'll show up as USB storage",
                "Drag the saved file onto the BBC micro:bit",
                "That's it!"
            ];
            instructions.forEach(function(val, index, arr) {
                var item = document.createElement('li');
                item.setChildren(val);
                list_items.push(item);
            });
            var ordered_list = document.createElement("ol");
            ordered_list.style.fontSize = "18px";
            ordered_list.setChildren(list_items);
            var info_box = div("infobox", [snake_img, header, ordered_list]);
            info_box.style.border = "6px solid #FFCC33";
            info_box.style.background = "#FFFFFF";
            info_box.style.borderRadius = "0px 20px 20px 20px";
            info_box.style.width = "100%";
            info_box.style.padding = "8px";
            info_box.style.marginTop = "32px";
            info_box.style.marginBottom = "64px";
            wrapper.setChildren([info_box]);
        } else {
            elt("externalEditorSide").style.background = "#FFFFFF url(https://az742082.vo.msecnd.net/pub/psopafpj) 0 0 repeat";
            var bbcLogo = div("wallFullScreenLogo", HTML.mkImg(Cloud.config.companyLogoHorizontalUrl));
            var logo = div("wallFullScreenLogo", HTML.mkImg(TheChannel.editor.logoUrl));
            var wrapper = div("wallFullScreenWrapper");
            wrapper.setChildren([w]);
        }
        elt("externalEditorSide").setChildren([bbcLogo, wrapper, logo]);
      }

      public fullWallWidth() {
        return (<HTMLElement> document.querySelector(".wallFullScreenContainer")).offsetWidth;
      }

      public fullWallHeight() {
        return (<HTMLElement> document.querySelector(".wallFullScreenContainer")).offsetHeight;
      }

      public setFullScreenElement(element) {
        (<any> this).fullScreenContainer.setChildren(element);
      }
    }

    function typeCheckAndRunAsync(text: string, mainName = "main") : Promise {
      return Embedded.parseScript(text).then((a: AST.App) => {
        J.setStableId(a);
        // The call to [tcApp] also has the desired side-effect of resolving
        // names.
        // let editors deal with typeerrors
        if (AST.TypeChecker.tcApp(a) > 0) {
            TheChannel.post(<Message_TypeCheck> {
                type: MessageType.TypeCheck,
                ast: AST.Json.dump(a),
            });
        }

        // The compiler expects this global to be set. However, this is
        // dangerous, since the sync code might want to write the *translated*
        // script text to storage for us. Fortunately, the compiler is
        // synchronous, so it shouldn't happen.
        Script = a;
        var compiledScript = AST.Compiler.getCompiledScript(a, {});
        Script = null;
        var rt = TheEditor.currentRt;
        if (!rt)
          rt = TheEditor.currentRt = new Runtime();
        rt.initFrom(compiledScript);
        if (!(rt.host instanceof ExternalHost))
          rt.setHost(new ExternalHost());
        rt.host.currentGuid = ScriptEditorWorldInfo.guid;
        rt.initPageStack();
        // Requires [TheChannel] to be setup properly (so that we know which
        // editor logo to show).
        (<EditorHost> rt.host).showWall();

        //rt.sessions.setEditorScriptContext(Cloud.getUserId(), ScriptEditorWorldInfo.guid, "no name",
        //      TheEditor.getBaseScriptId(), TheEditor.getCurrentAuthorId());

        var main = compiledScript.actionsByName[mainName];
        rt.stopAsync().done(() => {
          rt.run(main, []);
          // So that key events, such as escape, are not caught by Blockly.
          if (document.activeElement instanceof HTMLElement)
            (<HTMLElement> document.activeElement).blur();
        });
      });
    }

    export class Channel {
      private iframeFocused: Boolean = false;
      constructor(
        public editor: ExternalEditor,
        private iframe: HTMLIFrameElement,
        public guid: string) {
      }

      public post(message: Message) {
        // The notification that the script has been successfully saved
        // to cloud may take a while to arrive; the user may have
        // discarded the editor in the meanwhile.
        if (!this.iframe || !this.iframe.contentWindow)
          return;
        this.iframe.contentWindow.postMessage(message, this.editor.origin);
      }

      public receive(event) {

        if (!this.iframeFocused) { this.iframe.focus(); this.iframeFocused = true; }
        if (event.origin != this.editor.origin)
          return;
        Util.log('editor: received ' + JSON.stringify(event, null, 2));
        switch ((<Message> event.data).type) {
            case MessageType.Save: {
            tick(Ticks.externalSave);
            var message = <Message_Save>event.data;
            Util.assert(!!this.guid);
            Promise.join([
              World.getInstalledHeaderAsync(this.guid),
              World.getInstalledScriptAsync(this.guid),
              World.getInstalledEditorStateAsync(this.guid)
            ]).then((res: any[]) => {
              var header: Cloud.Header = <Cloud.Header>res[0];
              var installedState = JSON.stringify(res);

              var scriptText = message.script.scriptText;
              var editorState = JSON.stringify(message.script.editorState);
              header.scriptVersion.baseSnapshot = message.script.baseSnapshot;
              // This may be over-optimistic (the external editor may serve on
              // top of a version that's already outdated), but the sync code
              // will re-flag the pending merge later on.
              header.pendingMerge = null;

              var metadata = message.script.metadata;
              Object.keys(metadata).forEach(k => {
                var v = metadata[k];
                if (k == "name")
                  v = v || "unnamed";
                header.meta[k] = v;
              });
              // [name] deserves a special treatment because it
              // appears both on the header and in the metadata.
              header.name = metadata.name;

              // don't update if no changes
              var backgroundUpdate = installedState == JSON.stringify([header, scriptText, editorState]);
              var hasChanges = !backgroundUpdate;

              // Writes into local storage. Also clears the scriptVersionInCloud
              // field (fifth argument).
              World.updateInstalledScriptAsync(header, scriptText, editorState, backgroundUpdate).then(() => {
                console.log("[external] script saved properly");
                this.post(<Message_SaveAck>{
                  type: MessageType.SaveAck,
                  where: SaveLocation.Local,
                  status: Status.Ok,
                  changed: hasChanges
                });
              });

              // Schedules a cloud sync; set the right state so
              // that [scheduleSaveToCloudAsync] writes the
              // baseSnapshot where we can read it back.
              localStorage["editorScriptToSaveDirty"] = this.guid;
              TheEditor.scheduleSaveToCloudAsync().then((response: Cloud.PostUserInstalledResponse) => {
                // Reading the code of [scheduleSaveToCloudAsync], an early falsy return
                // means that a sync is already scheduled.
                if (!response)
                  return;

                if (response.numErrors) {
                  this.post(<Message_SaveAck>{
                    type: MessageType.SaveAck,
                    where: SaveLocation.Cloud,
                    status: Status.Error,
                    error: (<any> response.headers[0]).error,
                  });
                  // Couldn't sync! Chances are high that we need to do a merge.
                  // Because [syncAsync] is not called on a regular basis when an
                  // external editor is open, we need to trigger the download of
                  // the newer version from the cloud *now*.
                  World.syncAsync().then(() => {
                    World.getInstalledScriptVersionInCloud(this.guid).then((json: string) => {
                      var m: PendingMerge = JSON.parse(json || "{}");
                      if ("theirs" in m) {
                        this.post(<Message_Merge>{
                          type: MessageType.Merge,
                          merge: m
                        });
                      } else {
                        console.log("[external] cloud error was not because of a due merge");
                      }
                    });
                  });
                  return;
                }

                var newCloudSnapshot = response.headers[0].scriptVersion.baseSnapshot;
                console.log("[external] accepted, new cloud version ", newCloudSnapshot);
                // Note: currently, [response.retry] is always false. The reason is,
                // every call of us to [updateInstalledScriptAsync] is immediately
                // followed by a call to [scheduleSaveToCloudAsync]. Furthermore,
                // the latter function has its own tracking mechanism where updates
                // are delayed, and it sort-of knows if it missed an update and
                // should retry. In that case, it doesn't return until the second
                // update has been processed, and we only get called after the cloud
                // is, indeed, in sync. (If we were to offer external editors a way
                // to decide whether to save to cloud or not, then this would no
                // longer be true.)
                this.post(<Message_SaveAck>{
                  type: MessageType.SaveAck,
                  where: SaveLocation.Cloud,
                  status: Status.Ok,
                  newBaseSnapshot: newCloudSnapshot,
                  cloudIsInSync: !response.retry,
                });
              });
            });
            break;
          }

          case MessageType.Quit:
            TheEditor.goToHub("list:installed-scripts:script:"+this.guid+":overview");
            TheChannel = null;
            break;

          case MessageType.Compile:
            tick(Ticks.externalCompile);
            if (TheEditor.useNativeCompilation() && Cloud.anonMode(lf("C++ compilation"))) {
              this.post(<Message_CompileAck>{
                type: MessageType.CompileAck,
                status: Status.Error,
                error: "please log in for compilation"
              });
              return;
            }

            var message1 = <Message_Compile> event.data;

            // Let's abuse the [Language] enum. After the assignment, if
            // [language == CPlusPlus], then this means we want to go the cloud
            // compilation route. Otherwise, if [language == TouchDevelop], it
            // means we want to got the "bitvm" route.
            var compileLanguage, code;
            switch (message1.language) {
              case Language.CPlusPlus:
                // We got C++ in, we therefore want to compile some C++.
                compileLanguage = Language.CPlusPlus;
                code = Promise.as(message1.text);
                break;
              case Language.TouchDevelop:
                fixupLibs(message1.libs);
                // We got a TouchDevelop AST.
                if (AST.allowCppCompiler && message1.text.useCppCompiler) {
                  // The external editor demands C++ compilation. Generate the
                  // C++ code
                  compileLanguage = Language.CPlusPlus;
                  code = roundtrip(message1.text, message1.libs).then((a: J.JApp) => {
                    return Embedded.compile(a);
                  });
                } else {
                  // The external editor is fine with compiling with "bitvm".
                  compileLanguage = Language.TouchDevelop;
                  code = roundtrip1(message1.text, message1.libs);
                }
                break;
            }

            switch (compileLanguage) {
              case Language.CPlusPlus:
                // Native C++ compilation.
                TheEditor.compileWithUi(this.guid, code, message1.name).then(json => {
                  console.log(json);
                  // Aborted because of a retry, perhaps.
                  if (!json)
                    return;

                  if (json.success) {
                    this.post(<Message_CompileAck>{
                      type: MessageType.CompileAck,
                      status: Status.Ok
                    });
                    document.location.href = json.hexurl;
                  } else {
                    var errorMsg = Embedded.makeOutMbedErrorMsg(json);
                    this.post(<Message_CompileAck>{
                      type: MessageType.CompileAck,
                      status: Status.Error,
                      error: errorMsg
                    });
                  }
                }, (json: string) => {
                  // Failure
                  console.log(json);
                  this.post(<Message_CompileAck>{
                    type: MessageType.CompileAck,
                    status: Status.Error,
                    error: "early error"
                  });
                });
                break;

              case Language.TouchDevelop:
                // In-browser "bitvm" compilation.
                code.then((ast: AST.App) => {
                  try {
                    ast.localGuid = this.guid;
                    TheEditor.bytecodeCompileWithUi(ast, { showSource: false, uploader: this.editor.id == "blockly", source: message1.source });
                    this.post(<Message_CompileAck>{
                      type: MessageType.CompileAck,
                      status: Status.Ok
                    });
                  } catch (e) {
                    this.post(<Message_CompileAck>{
                      type: MessageType.CompileAck,
                      status: Status.Error,
                      error: ""+e
                    });
                  }
                });
                break;
            }
            break;

          case MessageType.Upgrade:
            var message2 = <Message_Upgrade> event.data;
            this.receiveUpgrade(message2);
            break;

          case MessageType.Help:
            var msgh = <Message_Help>event.data;
            var path = msgh.path;
            var ptr: JsonPointer;
            var editorSide = elt("externalEditorSide");
            editorSide.setChildren([div("externalEditorHelp", lf("loading..."))]);
            var rt = TheEditor.currentRt;
            var p = rt ? rt.stopAsync() : Promise.as();
            p.then(() => Cloud.getPrivateApiAsync("ptr" + path.replace(/\//g, "-")))
                .then((p: JsonPointer) => {
                    if (!p) return new PromiseInv();
                    ptr = p;
                    return Cloud.getScriptTextAsync(ptr.scriptid);
                }).then((text: string) => {
                    var ht = HelpTopic.fromScriptText(ptr.scriptid, text);
                    var rend = new Renderer();
                    rend.stringLimit = 90;
                    rend.mdComments.useExternalLinks = true;
                    rend.mdComments.showCopy = false;
                    rend.mdComments.forWeb = true;
                    return ht.renderAsync(rend.mdComments);
                }).done((html:string) => {
                    var doc = div("externalEditorHelp");
                    Browser.setInnerHTML(doc, html);
                    if (editorSide.offsetWidth == 0) {
                        var m = new ModalDialog();
                        m.add(doc);
                        m.stretchWide();
                        m.setScroll();
                        m.addOk();
                        m.show();
                    } else {
                        editorSide.setChildren([doc]);
                        editorSide.classList.remove("dismissed");
                    }
                }, e => {
                    Util.reportError("help", e, false);
                    editorSide.setChildren([div("externalEditorHelp",lf("oops, could not load the documentation."))]);
                    window.open(path);
                });
            break;
          case MessageType.Run:
            tick(Ticks.externalRun);
            var message3 = <Message_Run> event.data;
            var side = document.getElementById("externalEditorSide");
            if (message3.onlyIfSplit && side.offsetWidth == 0)
              break;
            side.classList.remove("dismissed");
            // So that key events such as escape are caught by the editor, not
            // the inner iframe.
            var ast: AST.Json.JApp = message3.ast;
            fixupLibs(message3.libs);
            addLibraries(ast, message3.libs)
            .then(() => {
              var text = J.serialize(ast);
              return typeCheckAndRunAsync(text);
            }).done();
            break;

          case MessageType.Load:
            tick(Ticks.externalLoad);
            var message4 = <Message_Load> event.data;
            ArtUtil.handleImportFilesAsync([message4.file]).done();
            break;

          default:
            // Apparently the runtime loop of the simulator is implemented using
            // messages sent to all origins... see [rt/util.ts]. So just don't do
            // anything if we receive an unrecognized message.
            break;
        }
      }

      private receiveUpgrade(message2: Message_Upgrade) {
            var ast: AST.Json.JApp = message2.ast;
            fixupLibs(message2.libs);
            addLibraries(ast, message2.libs).then(() => {;
              console.log("Attempting to serialize", ast);
              var text = J.serialize(ast);
              console.log("Attempting to edit script text", text);

              var m = new ModalDialog();
              m.add(div('wall-dialog-header', lf("here is your code")))
              m.add(div('wall-dialog-body',
                lf("By dragging and placing blocks, you've created the following code.")))
              var preview = div('');
              m.add(preview);
              Embedded.parseScript(text)
                .done((app: AST.App) => {
                  var main = app.mainAction();
                  var r = new Renderer();
                  Browser.setInnerHTML(preview, r.dispatch(main));
                });
              m.add(div('wall-dialog-buttons', [
                HTML.mkButton(lf("convert"), () => {
                  m.dismiss();
                  Browser.TheHost.openNewScriptAsync({
                    editorName: "touchdevelop",
                    scriptName: message2.name,
                    scriptText: text
                  }).done(() => {
                    // Release focus, kill the channel.
                    if (document.activeElement instanceof HTMLElement)
                      (<HTMLElement> document.activeElement).blur();
                    TheChannel = null;
                  });
                }),
                HTML.mkButton(lf("cancel"), () => m.dismiss())
              ]))
              m.setScroll();
              m.show();
            }).done();
      }
    }

    export interface ScriptData {
      guid: string;
      scriptText: string;
      editorState: EditorState;
      scriptVersionInCloud: string;
      baseSnapshot: string;
      metadata: Metadata;
      pubId: string;
    };

    window.addEventListener("resize", () => {
      if (TheChannel)
        TheChannel.post({
          type: MessageType.Resized,
        });
    });

    // The [scriptVersionInCloud] name is the one that's used by [world.ts];
    // actually, it hasn't much to do, really, with the script version
    // that's in the cloud. It's more of an unused field (in the new "lite
    // cloud" context) that we use to store extra information attached to
    // the script.
    export function loadAndSetup(editor: ExternalEditor, data: ScriptData) {
      // The [scheduleSaveToCloudAsync] method on [Editor] needs the
      // [guid] field of this global to match for us to read back the
      // [baseSnapshot] field afterwards.
      ScriptEditorWorldInfo = <EditorWorldInfo>{
        guid: data.guid,
        baseId: null,
        baseUserId: null,
        status: null,
        version: null,
        baseSnapshot: null,
      };

      Ticker.setCurrentEditorId(editor.id);

      // Clear leftover iframes and simulators.
      var editorSide = elt("externalEditorSide");
      editorSide.setChildren([]);
      var iframeDiv = elt("externalEditorFrame");
      iframeDiv.setChildren([]);

      // Load the editor; send the initial message.
      var iframe = document.createElement("iframe");
      // allow-popups is for the Blockly help menu item; allow-modals is for the
      // rename variable prompt
      iframe.setAttribute("sandbox", "allow-modals allow-scripts allow-same-origin allow-popups");
      iframe.addEventListener("load", () => {

        TheChannel = new Channel(editor, iframe, data.guid);

        // Start the simulator. This assumes that [TheChannel] is properly
        // setup.
        pullLatestLibraryVersion(microbitScriptId)
        .then((pubId: string) => ScriptCache.getScriptAsync(pubId))
        .then((s: string) => typeCheckAndRunAsync(s, "_libinit"))
        .done(() => {
          // Send the initialization message once the simulator is properly
          // setup.
          var extra = JSON.parse(data.scriptVersionInCloud || "{}");
          TheChannel.post(<Message_Init> {
            type: MessageType.Init,
            script: data,
            merge: ("theirs" in extra) ? extra : null,
            fota: Cloud.isFota(),
            pubId: data.pubId,
          });
        });
      });
      iframe.setAttribute("src", editor.origin + editor.path);
      iframeDiv.appendChild(iframe);

      // Change the hash and the window title.
      TheEditor.historyMgr.setHash("edit:" + data.guid, editor.name);
    }

    export function pickUpNewBaseVersion() {
      if (TheChannel)
        TheChannel.post(<Message_NewBaseVersion> {
          type: MessageType.NewBaseVersion,
          baseSnapshot: ScriptEditorWorldInfo.baseSnapshot
        });
    }
  }
}

// vim: set ts=2 sw=2 sts=2:
